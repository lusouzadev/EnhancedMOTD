name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'  # Matches tags like: v1.1.0+neoforge-1.21.1, v1.0.5+fabric-1.20.1

permissions:
  contents: write  # Required to create GitHub releases

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 21
          cache: 'gradle'

      - name: Make gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Extract version info from tag
        id: version_info
        run: |
          # Tag format: v1.1.0+neoforge-1.21.1
          TAG=${GITHUB_REF#refs/tags/}
          echo "Full tag: $TAG"

          # Remove 'v' prefix
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Extract loader (neoforge or fabric)
          LOADER=$(echo $VERSION | sed -n 's/.*+\([^-]*\)-.*/\1/p')
          echo "loader=$LOADER" >> $GITHUB_OUTPUT

          # Extract minecraft version
          MC_VERSION=$(echo $VERSION | sed -n 's/.*+[^-]*-\(.*\)/\1/p')
          echo "mc_version=$MC_VERSION" >> $GITHUB_OUTPUT

          # Extract mod version (before the +)
          MOD_VERSION=$(echo $VERSION | sed -n 's/\([^+]*\)+.*/\1/p')
          echo "mod_version=$MOD_VERSION" >> $GITHUB_OUTPUT

      - name: Build with Gradle
        run: ./gradlew build --no-daemon

      - name: Find JAR file
        id: find_jar
        run: |
          # Find the main JAR (exclude sources and javadoc)
          JAR_FILE=$(find build/libs -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -n 1)
          echo "jar_file=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "jar_name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_FILE"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.find_jar.outputs.jar_file }}
            build/libs/*-sources.jar
          generate_release_notes: true
          draft: false
          prerelease: false
          name: ${{ steps.version_info.outputs.version }}
          body: |
            **Random MOTD ${{ steps.version_info.outputs.mod_version }}**

            - Loader: **${{ steps.version_info.outputs.loader }}**
            - Minecraft: **${{ steps.version_info.outputs.mc_version }}**

            ### Installation
            1. Download the JAR file below
            2. Place it in your server's `mods` folder
            3. Restart the server

            See the [README](https://github.com/${{ github.repository }}) for configuration instructions.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Modrinth publishing (uncomment when ready to use)
      # You'll need to:
      # 1. Create a project on Modrinth: https://modrinth.com/dashboard/projects
      # 2. Get your project ID from the project settings
      # 3. Generate an API token: https://modrinth.com/settings/pats
      # 4. Add the token to GitHub Secrets as MODRINTH_TOKEN
      #    Go to: Repository Settings > Secrets and variables > Actions > New repository secret
      #
      # - name: Publish to Modrinth
      #   uses: Kir-Antipov/mc-publish@v3.3
      #   with:
      #     modrinth-id: YOUR_MODRINTH_PROJECT_ID  # Replace with your project ID
      #     modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
      #
      #     files: ${{ steps.find_jar.outputs.jar_file }}
      #     name: Random MOTD ${{ steps.version_info.outputs.version }}
      #     version: ${{ steps.version_info.outputs.version }}
      #     version-type: release
      #
      #     loaders: ${{ steps.version_info.outputs.loader }}
      #     game-versions: ${{ steps.version_info.outputs.mc_version }}
      #
      #     java: 21
      #
      #     changelog-file: CHANGELOG.md
