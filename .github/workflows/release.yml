name: Release

on:
  push:
    branches:
      - 'neoforge/**'
      - 'fabric/**'
      - 'ci/workflow-update'  # Temporary: testing branch

permissions:
  contents: write  # Required to create tags and releases

# Prevent race conditions: only one release per branch at a time
concurrency:
  group: semantic-release-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel, let them queue

jobs:
  # Wait for build to complete successfully
  build:
    uses: ./.github/workflows/build.yml

  release:
    needs: build  # Only run if build succeeds
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for semantic release
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install semantic-release dependencies
        run: |
          npm install -g semantic-release@23 \
            @semantic-release/git@10 \
            @semantic-release/changelog@6 \
            @semantic-release/exec@6 \
            conventional-changelog-conventionalcommits@7

      - name: Determine version suffix from branch and gradle.properties
        id: branch_info
        run: |
          BRANCH=${GITHUB_REF#refs/heads/}
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          # Extract loader from branch name (e.g., neoforge/1.21.x -> neoforge)
          # For test branches like 'ci/workflow-update', use the whole branch name
          if [[ "$BRANCH" == neoforge/* ]] || [[ "$BRANCH" == fabric/* ]]; then
            LOADER=$(echo $BRANCH | cut -d'/' -f1)
          else
            # For test branches, use sanitized branch name
            LOADER=$(echo $BRANCH | sed 's/\//-/g')
          fi
          echo "loader=$LOADER" >> $GITHUB_OUTPUT

          # Extract actual Minecraft version from gradle.properties
          MC_VERSION=$(grep '^minecraft_version=' gradle.properties | cut -d'=' -f2)
          echo "mc_version=$MC_VERSION" >> $GITHUB_OUTPUT

          # Create suffix: loader-minecraft_version (e.g., neoforge-1.21.1 or ci-workflow-update-1.21.1)
          SUFFIX="${LOADER}-${MC_VERSION}"
          echo "suffix=$SUFFIX" >> $GITHUB_OUTPUT

          echo "Branch: $BRANCH"
          echo "Loader: $LOADER"
          echo "Minecraft Version: $MC_VERSION"
          echo "Version suffix: $SUFFIX"

      - name: Run Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION_SUFFIX: ${{ steps.branch_info.outputs.suffix }}
        run: npx semantic-release

      - name: Output result
        if: always()
        run: |
          echo "Semantic release completed for branch ${{ steps.branch_info.outputs.branch }}"
          echo "Check if a new version was released above"
